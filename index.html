<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apple Inc. (AAPL) — Live KPI & Revenue</title>
  <meta name="description" content="Apple KPI live (Market Cap, P/E, EPS) + grafic de revenue, alimentat din Alpha Vantage." />
  <link rel="icon" href="favicon.ico" />

  <style>
    :root{
      --bg:#0b0b0f; --text:#fafafa; --muted:#a1a1aa;
      --card:#12121a; --border:#252536; --panel:#14141b;
      --green:#00ff84;
      --rev-h: clamp(320px, 45vh, 460px);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    .container{max-width:1100px;margin:0 auto;padding:0 18px}
    h1{font-size:clamp(26px,3.8vw,40px);line-height:1.1;margin:26px 0 6px}
    h2{font-size:clamp(20px,3vw,28px);margin:16px 0 8px}
    .muted{color:var(--muted)} .small{font-size:13px}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;margin:14px 0}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;min-height:92px}
    .k{font-size:13px;color:#cbd5e1;margin-bottom:8px}
    .v{font-size:28px;font-weight:700;min-height:32px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:18px}
    .revenue{padding:14px}
    #appleRevenueChart{display:block;width:100%;height:var(--rev-h)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:14px 0}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
    .infoBox{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .badge{display:inline-block;padding:2px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .row{display:flex;align-items:center;gap:8px}
  </style>
</head>
<body>
  <main class="container">
    <h1>Apple Inc. (AAPL) — Live KPI & Revenue</h1>
    <p class="muted small">Date live din Alpha Vantage. Valorile sunt actualizate periodic; pot exista mici diferențe față de alte agregatoare.</p>

    <!-- KPI -->
    <section class="kpis">
      <div class="card">
        <div class="k">Market Cap</div>
        <div class="v" id="marketcap">—</div>
      </div>
      <div class="card">
        <div class="k">P/E (TTM)</div>
        <div class="v" id="pe">—</div>
      </div>
      <div class="card">
        <div class="k">EPS (TTM)</div>
        <div class="v" id="eps">—</div>
      </div>
      <div class="card">
        <div class="k">5Y CAGR (Revenue)</div>
        <div class="v" id="cagr">—</div>
      </div>
    </section>

    <!-- Revenue chart -->
    <section>
      <h2>Revenue &amp; Financials</h2>
      <p class="muted small">Grafic anual al veniturilor Apple (miliarde USD). Click pe un an pentru suma exactă.</p>
      <div class="panel revenue">
        <canvas id="appleRevenueChart" aria-label="Apple Revenue"></canvas>
      </div>

      <div class="grid-2">
        <div class="infoBox">
          <div class="k">An selectat</div>
          <div class="v" id="revYear">—</div>
          <div class="k" style="margin-top:10px">Revenue exact</div>
          <div class="v" id="revValue">—</div>
        </div>
        <div class="infoBox">
          <div class="k">Metodologie</div>
          <p class="muted small">Annual revenue (FY), în miliarde USD. Sursa: Alpha Vantage (funcția <code>INCOME_STATEMENT</code>), prelucrat client-side. Valorile pot avea rotunjiri minore.</p>
          <div class="row"><span class="badge" id="lastUpdated">—</span><span class="muted small">ultima actualizare</span></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Chart.js (o singură dată) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Alpha Vantage – LIVE -->
  <script>
  // ===== CONFIG =====
  const KEY = "XE5ORMNMWAJ8IMWG";   // cheia ta Alpha Vantage
  const CACHE_MIN = 30;              // cache local 30 min (evită limitele)
  const el = { mc:"marketcap", pe:"pe", eps:"eps", cagr:"cagr", canvas:"appleRevenueChart", y:"revYear", v:"revValue", stamp:"lastUpdated" };

  // formatare
  const fmt = {
    trillions: n => "$" + (n/1e12).toFixed(2) + "T",
    usd: n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(n),
    two: n => (+n).toFixed(2)
  };

  // cache simplu în localStorage
  async function cachedFetch(key, url){
    const k = "av:"+key, now = Date.now();
    const hit = JSON.parse(localStorage.getItem(k) || "null");
    if (hit && (now - hit.t) < CACHE_MIN*60*1000) return hit.d;
    const r = await fetch(url);
    if(!r.ok) throw new Error("HTTP "+r.status);
    const d = await r.json();
    localStorage.setItem(k, JSON.stringify({ t: now, d }));
    return d;
  }

  // KPI (MarketCap, P/E, EPS)
  async function loadKPI(){
    const j = await cachedFetch("OVERVIEW",
      `https://www.alphavantage.co/query?function=OVERVIEW&symbol=AAPL&apikey=${KEY}`);
    document.getElementById(el.mc).textContent  = fmt.trillions(+j.MarketCapitalization);
    document.getElementById(el.pe).textContent  = fmt.two(+j.PERatio);
    document.getElementById(el.eps).textContent = fmt.two(+j.EPS);
  }

  // Revenue + 5Y CAGR + grafic + click pe bară
  let chart;
  async function loadRevenue(){
    const j = await cachedFetch("INCOME",
      `https://www.alphavantage.co/query?function=INCOME_STATEMENT&symbol=AAPL&apikey=${KEY}`);

    const rows = (j.annualReports||[])
      .map(r => ({ y:+r.fiscalDateEnding.slice(0,4), v:+r.totalRevenue }))
      .filter(r => r.y && r.v)
      .sort((a,b)=>a.y-b.y);               // ani crescător

    // 5Y CAGR
    if (rows.length >= 6){
      const last = rows[rows.length-1].v, prev5 = rows[rows.length-6].v;
      const cagr = (Math.pow(last/prev5, 1/5)-1)*100;
      document.getElementById(el.cagr).textContent = "~ " + fmt.two(cagr) + "%";
    }

    // pregătim chart data (miliarde USD)
    const labels = rows.map(r=>String(r.y));
    const data   = rows.map(r=>r.v/1e9);

    const ctx = document.getElementById(el.canvas).getContext("2d");
    if (chart) chart.destroy();
    chart = new Chart(ctx,{
      type:"bar",
      data:{ labels, datasets:[{ label:"Revenue (Billion USD)", data, borderWidth:1.5, borderRadius:6 }] },
      options:{
        maintainAspectRatio:false,
        scales:{
          x:{ ticks:{ color:"#bbb" }, grid:{ color:"#1f1f28" } },
          y:{ beginAtZero:true, ticks:{ color:"#bbb", callback:v=>"$"+v.toFixed(0)+"B" }, grid:{ color:"#1f1f28" } }
        },
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label:c=>"Revenue: "+fmt.usd(rows[c.dataIndex].v) } }
        }
      }
    });

    // select implicit ultimul an + click pe bară pentru detaliu
    const yEl = document.getElementById(el.y);
    const vEl = document.getElementById(el.v);
    const setRow = i=>{
      if(!yEl || !vEl) return;
      yEl.textContent = labels[i];
      vEl.textContent = fmt.usd(rows[i].v) + " (" + data[i].toFixed(2) + "B)";
    };
    setRow(labels.length-1); // ultimul
    ctx.canvas.onclick = evt=>{
      const p = chart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
      if(p.length) setRow(p[0].index);
    };
  }

  function stamp(){
    const t = new Date().toLocaleString();
    const s = document.getElementById(el.stamp);
    if(s) s.textContent = t;
  }

  async function init(){ await loadKPI(); await loadRevenue(); stamp(); }
  init();
  // refresh orar (poți mări/micșora)
  setInterval(init, 60*60*1000);
  </script>
</body>
</html>
